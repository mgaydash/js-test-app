<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		<script src="../js/jquery-1.7.2.min.js" type="text/javascript"></script>
		<script src="../js/jquery.ui.position.js" type="text/javascript"></script>
		<script src="../js/jquery.contextMenu.js" type="text/javascript"></script>
		<script src="../js/jquery-ui-1.8.21.custom.min.js" type="text/javascript"></script>
		<link href="../css/contextMenu/jquery.contextMenu.css" rel="stylesheet" type="text/css" />
		<link href="../css/jQUi/jquery-ui-1.8.21.custom.css" rel="stylesheet" type="text/css" />
		<link href="../css/test.css" rel="stylesheet" type="text/css" />
		<title>
			2 way binding
		</title>
		<script type="text/javascript">
			jQuery(document).ready(function() {
				jQuery('body').prepend('<div id="nav"></div>');
				jQuery.get(
					"../view/nav.html",
					function(response) {
						jQuery("#nav").html(response);
					},
					"html"
				);

				var user = new User(123);
				var boat = new User(124);
				//user.set("name", "Wolfgang");
			});

			function DataBinder(object_id) {
				var pubSub = jQuery({});
				var data_attr = "bind-" + object_id,
					message = object_id + ":change";

				jQuery(document).on("keyup", "[data-" + data_attr + "]", function(evt) {
					var $input = jQuery(this);

					pubSub.trigger(message, [$input.data(data_attr), $input.val()]);
				});

				pubSub.on(message, function(evt, prop_name, new_val) {
					jQuery("[data-" + data_attr + "=" + prop_name + "]").each(function() {
						var $bound = jQuery(this);

						if ($bound.is("input, textarea, select")) {
							$bound.val(new_val);
						} else {
							$bound.html(new_val);
						}
					});
				});
				return pubSub;
			}
			
			function User(uid) {
				var binder = new DataBinder(uid),
				user = {
					attributes: {},
					set: function(attr_name, val) {
						this.attributes[ attr_name ] = val;
						binder.trigger(uid + ":change", [attr_name, val, this]);
					},
					get: function(attr_name) {
						return this.attributes[ attr_name ];
					},
					_binder: binder
				};

				binder.on(uid + ":change", function(evt, attr_name, new_val, initiator) {
					if (initiator !== user) {
						user.set(attr_name, new_val);
					}
				});

				return user;
			}
		</script>
		<style>

		</style>
	</head>
	<body>
		<h2 id="header">2 way binding</h2>

		<input type="text" data-bind-123="name" />
		<input type="text" data-bind-123="title" />
		<input type="text" data-bind-124="name" />

		<div data-bind-123="name" style="border:1px solid blue; height:20px; width:200px;"></div>
		<div data-bind-123="title" style="border:1px solid blue; height:20px; width:200px;"></div>
		<div data-bind-124="name" style="border:1px solid blue; height:20px; width:200px;"></div>
	</body>
</html>